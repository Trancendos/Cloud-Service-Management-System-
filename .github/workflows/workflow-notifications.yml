name: Workflow Run Notifications

on:
  workflow_run:
    workflows: ["*"]
    types:
      - completed
      - requested

jobs:
  notify:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Get workflow run details
        id: workflow-details
        run: |
          echo "workflow_name=${{ github.event.workflow_run.name }}" >> $GITHUB_OUTPUT
          echo "workflow_status=${{ github.event.workflow_run.conclusion }}" >> $GITHUB_OUTPUT
          echo "workflow_url=${{ github.event.workflow_run.html_url }}" >> $GITHUB_OUTPUT
          echo "triggered_by=${{ github.event.workflow_run.triggering_actor.login }}" >> $GITHUB_OUTPUT
          echo "branch=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
          echo "commit_sha=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
          echo "event=${{ github.event.action }}" >> $GITHUB_OUTPUT
          
          # Get short commit SHA
          short_sha=$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-7)
          echo "short_sha=$short_sha" >> $GITHUB_OUTPUT
          
          # Determine emoji based on status
          case "${{ github.event.workflow_run.conclusion }}" in
            success)
              echo "status_emoji=âœ…" >> $GITHUB_OUTPUT
              echo "status_color=good" >> $GITHUB_OUTPUT
              ;;
            failure)
              echo "status_emoji=âŒ" >> $GITHUB_OUTPUT
              echo "status_color=danger" >> $GITHUB_OUTPUT
              ;;
            cancelled)
              echo "status_emoji=âš ï¸" >> $GITHUB_OUTPUT
              echo "status_color=warning" >> $GITHUB_OUTPUT
              ;;
            skipped)
              echo "status_emoji=â­ï¸" >> $GITHUB_OUTPUT
              echo "status_color=#808080" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "status_emoji=ðŸ”„" >> $GITHUB_OUTPUT
              echo "status_color=#808080" >> $GITHUB_OUTPUT
              ;;
          esac
      
      - name: Send Slack notification
        if: github.event.action == 'completed' && vars.ENABLE_SLACK_NOTIFICATIONS == 'true'
        uses: slackapi/slack-github-action@v1.26.0
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "${{ steps.workflow-details.outputs.status_emoji }} Workflow Run ${{ steps.workflow-details.outputs.workflow_status }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ steps.workflow-details.outputs.status_emoji }} Workflow: ${{ steps.workflow-details.outputs.workflow_name }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n${{ steps.workflow-details.outputs.workflow_status }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ steps.workflow-details.outputs.branch }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Triggered by:*\n${{ steps.workflow-details.outputs.triggered_by }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n${{ steps.workflow-details.outputs.short_sha }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow Run"
                      },
                      "url": "${{ steps.workflow-details.outputs.workflow_url }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      
      - name: Send email notification
        if: github.event.action == 'completed' && vars.ENABLE_EMAIL_NOTIFICATIONS == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "${{ steps.workflow-details.outputs.status_emoji }} Workflow '${{ steps.workflow-details.outputs.workflow_name }}' - ${{ steps.workflow-details.outputs.workflow_status }}"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ${{ secrets.MAIL_FROM }}
          body: |
            Workflow Run Notification
            
            Workflow: ${{ steps.workflow-details.outputs.workflow_name }}
            Status: ${{ steps.workflow-details.outputs.workflow_status }}
            Branch: ${{ steps.workflow-details.outputs.branch }}
            Triggered by: ${{ steps.workflow-details.outputs.triggered_by }}
            Commit: ${{ steps.workflow-details.outputs.short_sha }}
            
            View the workflow run: ${{ steps.workflow-details.outputs.workflow_url }}
            
            Repository: ${{ github.repository }}
          priority: normal
      
      - name: Find associated PR
        if: github.event.action == 'completed' && vars.ENABLE_GITHUB_COMMENTS == 'true'
        id: find-pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${{ steps.workflow-details.outputs.branch }}`
            });
            
            if (pulls.length > 0) {
              core.setOutput('pr_number', pulls[0].number);
              core.setOutput('has_pr', 'true');
            } else {
              core.setOutput('has_pr', 'false');
            }
      
      - name: Comment on PR with workflow result
        if: |
          github.event.action == 'completed' && 
          vars.ENABLE_GITHUB_COMMENTS == 'true' &&
          steps.find-pr.outputs.has_pr == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.workflow-details.outputs.workflow_status }}';
            const emoji = '${{ steps.workflow-details.outputs.status_emoji }}';
            const workflowName = '${{ steps.workflow-details.outputs.workflow_name }}';
            const workflowUrl = '${{ steps.workflow-details.outputs.workflow_url }}';
            const shortSha = '${{ steps.workflow-details.outputs.short_sha }}';
            
            const body = `${emoji} **Workflow Run Notification**
            
            **Workflow:** ${workflowName}
            **Status:** ${status}
            **Commit:** ${shortSha}
            
            [View Workflow Run](${workflowUrl})`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.find-pr.outputs.pr_number }},
              body: body
            });
      
      - name: Notification summary
        run: |
          echo "### Workflow Run Notification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ steps.workflow-details.outputs.workflow_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.workflow-details.outputs.status_emoji }} ${{ steps.workflow-details.outputs.workflow_status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ steps.workflow-details.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ steps.workflow-details.outputs.triggered_by }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ steps.workflow-details.outputs.short_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Notifications sent:**" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ vars.ENABLE_SLACK_NOTIFICATIONS }}" = "true" ]; then
            echo "- âœ… Slack notification" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âšª Slack notification (disabled)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ vars.ENABLE_EMAIL_NOTIFICATIONS }}" = "true" ]; then
            echo "- âœ… Email notification" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âšª Email notification (disabled)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ vars.ENABLE_GITHUB_COMMENTS }}" = "true" ]; then
            if [ "${{ steps.find-pr.outputs.has_pr }}" = "true" ]; then
              echo "- âœ… GitHub PR comment (PR #${{ steps.find-pr.outputs.pr_number }})" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âšª GitHub PR comment (no associated PR found)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- âšª GitHub PR comment (disabled)" >> $GITHUB_STEP_SUMMARY
          fi
