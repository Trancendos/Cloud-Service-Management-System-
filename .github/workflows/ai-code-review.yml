name: AI Code Review

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
  pull_request_review:
    types:
      - submitted

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  ai-code-review:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Get changed files
        id: changed-files
        run: |
          # Get the list of changed files
          git fetch origin ${{ github.event.pull_request.base.ref }}
          changed_files=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD)
          
          # Count files
          file_count=$(echo "$changed_files" | wc -l)
          
          # Filter for code files (exclude certain patterns)
          code_files=$(echo "$changed_files" | grep -E '\.(js|ts|py|java|go|rb|php|cs|cpp|c|h|yml|yaml|json|sh)$' || true)
          code_file_count=$(echo "$code_files" | grep -v '^$' | wc -l || echo "0")
          
          echo "file_count=$file_count" >> $GITHUB_OUTPUT
          echo "code_file_count=$code_file_count" >> $GITHUB_OUTPUT
          
          # Store files for analysis
          echo "$changed_files" > /tmp/changed_files.txt
          echo "$code_files" > /tmp/code_files.txt
          
          echo "Total files changed: $file_count"
          echo "Code files changed: $code_file_count"
      
      - name: Analyze code quality
        id: analyze
        run: |
          # Initialize analysis results
          security_issues=0
          quality_issues=0
          style_issues=0
          best_practice_issues=0
          
          # Read code files
          if [ -s /tmp/code_files.txt ]; then
            while IFS= read -r file; do
              if [ -f "$file" ]; then
                echo "Analyzing: $file"
                
                # Security checks
                # Check for hardcoded secrets patterns
                if grep -qiE '(password|secret|api_key|token|private_key)\s*=\s*["\047]' "$file" 2>/dev/null; then
                  ((security_issues++))
                  echo "âš ï¸ Potential hardcoded secret in $file"
                fi
                
                # Check for SQL injection patterns
                if grep -qE 'SELECT.*\+|INSERT.*\+|UPDATE.*\+' "$file" 2>/dev/null; then
                  ((quality_issues++))
                  echo "âš ï¸ Potential SQL injection risk in $file"
                fi
                
                # Quality checks
                # Check for console.log/print statements (should use proper logging)
                if grep -qE '^[^#]*console\.log|^[^#]*print\(' "$file" 2>/dev/null; then
                  ((style_issues++))
                fi
                
                # Check for TODO/FIXME comments
                if grep -qiE 'TODO|FIXME|HACK' "$file" 2>/dev/null; then
                  ((quality_issues++))
                fi
                
                # Best practices checks
                # Check for proper error handling in shell scripts
                if [[ "$file" == *.sh ]]; then
                  if ! grep -qE 'set -e|set -o errexit' "$file" 2>/dev/null; then
                    ((best_practice_issues++))
                  fi
                fi
              fi
            done < /tmp/code_files.txt
          fi
          
          # Calculate total issues
          total_issues=$((security_issues + quality_issues + style_issues + best_practice_issues))
          
          echo "security_issues=$security_issues" >> $GITHUB_OUTPUT
          echo "quality_issues=$quality_issues" >> $GITHUB_OUTPUT
          echo "style_issues=$style_issues" >> $GITHUB_OUTPUT
          echo "best_practice_issues=$best_practice_issues" >> $GITHUB_OUTPUT
          echo "total_issues=$total_issues" >> $GITHUB_OUTPUT
          
          echo "Analysis complete:"
          echo "  Security issues: $security_issues"
          echo "  Quality issues: $quality_issues"
          echo "  Style issues: $style_issues"
          echo "  Best practice issues: $best_practice_issues"
          echo "  Total issues: $total_issues"
      
      - name: Generate review report
        id: report
        env:
          FILE_COUNT: ${{ steps.changed-files.outputs.code_file_count }}
          TOTAL_ISSUES: ${{ steps.analyze.outputs.total_issues }}
          SECURITY_ISSUES: ${{ steps.analyze.outputs.security_issues }}
          QUALITY_ISSUES: ${{ steps.analyze.outputs.quality_issues }}
          STYLE_ISSUES: ${{ steps.analyze.outputs.style_issues }}
          BEST_PRACTICE_ISSUES: ${{ steps.analyze.outputs.best_practice_issues }}
        run: |
          # Generate markdown report
          if [ "$TOTAL_ISSUES" -eq 0 ]; then
            # No issues found
            cat > /tmp/review_report.md << 'EOF'
          ## ðŸ¤– AI Code Review Report
          
          **Files Reviewed:** $FILE_COUNT
          
          âœ… **Great work!** No issues found in this PR.
          
          ---
          *Check the workflow logs for detailed findings and recommendations.*
          
          **AI Review Capabilities:**
          - âœ… Security vulnerability detection
          - âœ… Code quality analysis
          - âœ… Style consistency checks
          - âœ… Best practices validation
          EOF
          else
            # Issues found
            cat > /tmp/review_report.md << 'EOF'
          ## ðŸ¤– AI Code Review Report
          
          **Files Reviewed:** $FILE_COUNT
          
          âš ï¸ **Issues Found:** $TOTAL_ISSUES
          
          ### Issue Breakdown
          - ðŸ”’ Security: $SECURITY_ISSUES
          - ðŸ“Š Code Quality: $QUALITY_ISSUES
          - ðŸŽ¨ Style: $STYLE_ISSUES
          - âœ¨ Best Practices: $BEST_PRACTICE_ISSUES
          
          ---
          
          ### ðŸ’¡ Recommendations
          
          Please review the workflow logs for detailed information about each issue.
          
          **Next Steps:**
          1. Review the identified issues in the workflow logs
          2. Address critical security and quality concerns
          3. Consider style and best practice improvements
          
          ---
          *Check the workflow logs for detailed findings and recommendations.*
          
          **AI Review Capabilities:**
          - âœ… Security vulnerability detection
          - âœ… Code quality analysis
          - âœ… Style consistency checks
          - âœ… Best practices validation
          EOF
          fi
          
          # Substitute variables
          sed -i "s/\$FILE_COUNT/$FILE_COUNT/g" /tmp/review_report.md
          sed -i "s/\$TOTAL_ISSUES/$TOTAL_ISSUES/g" /tmp/review_report.md
          sed -i "s/\$SECURITY_ISSUES/$SECURITY_ISSUES/g" /tmp/review_report.md
          sed -i "s/\$QUALITY_ISSUES/$QUALITY_ISSUES/g" /tmp/review_report.md
          sed -i "s/\$STYLE_ISSUES/$STYLE_ISSUES/g" /tmp/review_report.md
          sed -i "s/\$BEST_PRACTICE_ISSUES/$BEST_PRACTICE_ISSUES/g" /tmp/review_report.md
          
          # Show the report
          echo "Generated review report:"
          cat /tmp/review_report.md
          
          # Set output for next step
          echo "report_path=/tmp/review_report.md" >> $GITHUB_OUTPUT
      
      - name: Post review comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const reportPath = '${{ steps.report.outputs.report_path }}';
            const report = fs.readFileSync(reportPath, 'utf8');
            
            // Check if we already posted a review
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸ¤– AI Code Review Report')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
              console.log('Updated existing review comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
              console.log('Posted new review comment');
            }
      
      - name: Summary
        run: |
          echo "### AI Code Review Complete ðŸ¤–" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Files Reviewed:** ${{ steps.changed-files.outputs.code_file_count }}" >> $GITHUB_STEP_SUMMARY
          echo "**Total Issues:** ${{ steps.analyze.outputs.total_issues }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.analyze.outputs.total_issues }}" -eq 0 ]; then
            echo "âœ… No issues found!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Issues detected - please review the analysis above." >> $GITHUB_STEP_SUMMARY
          fi
