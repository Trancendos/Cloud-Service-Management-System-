name: Pull Request Notifications

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
      - closed

jobs:
  notify:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Get PR details
        id: pr-details
        run: |
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "pr_title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
          echo "pr_author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
          echo "pr_url=${{ github.event.pull_request.html_url }}" >> $GITHUB_OUTPUT
          echo "pr_action=${{ github.event.action }}" >> $GITHUB_OUTPUT
          echo "pr_state=${{ github.event.pull_request.state }}" >> $GITHUB_OUTPUT
          echo "pr_draft=${{ github.event.pull_request.draft }}" >> $GITHUB_OUTPUT
          echo "base_branch=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT
          echo "head_branch=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          
          # Get short commit SHA
          short_sha=$(echo "${{ github.event.pull_request.head.sha }}" | cut -c1-7)
          echo "short_sha=$short_sha" >> $GITHUB_OUTPUT
          
          # Determine emoji and action text based on PR action
          case "${{ github.event.action }}" in
            opened)
              echo "action_emoji=ðŸš€" >> $GITHUB_OUTPUT
              echo "action_text=opened" >> $GITHUB_OUTPUT
              ;;
            reopened)
              echo "action_emoji=ðŸ”„" >> $GITHUB_OUTPUT
              echo "action_text=reopened" >> $GITHUB_OUTPUT
              ;;
            synchronize)
              echo "action_emoji=ðŸ”„" >> $GITHUB_OUTPUT
              echo "action_text=updated" >> $GITHUB_OUTPUT
              ;;
            ready_for_review)
              echo "action_emoji=ðŸ‘€" >> $GITHUB_OUTPUT
              echo "action_text=ready for review" >> $GITHUB_OUTPUT
              ;;
            closed)
              if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
                echo "action_emoji=âœ…" >> $GITHUB_OUTPUT
                echo "action_text=merged" >> $GITHUB_OUTPUT
              else
                echo "action_emoji=âŒ" >> $GITHUB_OUTPUT
                echo "action_text=closed without merging" >> $GITHUB_OUTPUT
              fi
              ;;
            *)
              echo "action_emoji=ðŸ“" >> $GITHUB_OUTPUT
              echo "action_text=${{ github.event.action }}" >> $GITHUB_OUTPUT
              ;;
          esac
      
      - name: Send Slack notification
        if: vars.ENABLE_SLACK_NOTIFICATIONS == 'true'
        uses: slackapi/slack-github-action@v1.26.0
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "${{ steps.pr-details.outputs.action_emoji }} PR #${{ steps.pr-details.outputs.pr_number }} ${{ steps.pr-details.outputs.action_text }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ steps.pr-details.outputs.action_emoji }} Pull Request #${{ steps.pr-details.outputs.pr_number }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*${{ steps.pr-details.outputs.pr_title }}*"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Action:*\n${{ steps.pr-details.outputs.action_text }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ steps.pr-details.outputs.pr_author }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ steps.pr-details.outputs.head_branch }} â†’ ${{ steps.pr-details.outputs.base_branch }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n${{ steps.pr-details.outputs.short_sha }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Pull Request"
                      },
                      "url": "${{ steps.pr-details.outputs.pr_url }}"
                    }
                  ]
                }
              ]
            }
      
      - name: Send email notification
        if: vars.ENABLE_EMAIL_NOTIFICATIONS == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "${{ steps.pr-details.outputs.action_emoji }} PR #${{ steps.pr-details.outputs.pr_number }}: ${{ steps.pr-details.outputs.pr_title }}"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ${{ secrets.MAIL_FROM }}
          body: |
            Pull Request Notification
            
            PR #${{ steps.pr-details.outputs.pr_number }}: ${{ steps.pr-details.outputs.pr_title }}
            Action: ${{ steps.pr-details.outputs.action_text }}
            Author: ${{ steps.pr-details.outputs.pr_author }}
            Branch: ${{ steps.pr-details.outputs.head_branch }} â†’ ${{ steps.pr-details.outputs.base_branch }}
            Commit: ${{ steps.pr-details.outputs.short_sha }}
            State: ${{ steps.pr-details.outputs.pr_state }}
            Draft: ${{ steps.pr-details.outputs.pr_draft }}
            
            View the pull request: ${{ steps.pr-details.outputs.pr_url }}
            
            Repository: ${{ github.repository }}
          priority: normal
      
      - name: Notification summary
        run: |
          echo "### Pull Request Notification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR Number:** #${{ steps.pr-details.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Title:** ${{ steps.pr-details.outputs.pr_title }}" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ steps.pr-details.outputs.action_emoji }} ${{ steps.pr-details.outputs.action_text }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ steps.pr-details.outputs.pr_author }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ steps.pr-details.outputs.head_branch }} â†’ ${{ steps.pr-details.outputs.base_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ steps.pr-details.outputs.short_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Notifications sent:**" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ vars.ENABLE_SLACK_NOTIFICATIONS }}" = "true" ]; then
            echo "- âœ… Slack notification" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âšª Slack notification (disabled)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ vars.ENABLE_EMAIL_NOTIFICATIONS }}" = "true" ]; then
            echo "- âœ… Email notification" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âšª Email notification (disabled)" >> $GITHUB_STEP_SUMMARY
          fi
