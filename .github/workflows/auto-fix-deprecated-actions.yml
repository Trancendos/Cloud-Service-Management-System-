name: Auto-fix Deprecated Actions

on:
  schedule:
    # Run weekly on Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger
  push:
    paths:
      - '.github/workflows/*.yml'
      - '.github/workflows/*.yaml'

jobs:
  detect-and-fix-deprecated-actions:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Scan and fix deprecated actions
        id: fix-actions
        run: |
          # Initialize flags
          changes_made=false
          branch_name="automated/fix-deprecated-actions-$(date +%Y%m%d-%H%M%S)"
          
          # Create array to track changes
          declare -a changed_files
          
          # Find all workflow files
          workflow_files=$(find .github/workflows -type f \( -name "*.yml" -o -name "*.yaml" \) ! -name "auto-fix-deprecated-actions.yml")
          
          echo "Scanning workflow files for deprecated actions..."
          
          for file in $workflow_files; do
            if [ -f "$file" ]; then
              echo "Checking: $file"
              
              # Create a backup
              cp "$file" "${file}.bak"
              
              # Fix actions/cache@v1 -> actions/cache@v4
              if grep -q "actions/cache@v1" "$file"; then
                sed -i 's|actions/cache@v1|actions/cache@v4|g' "$file"
                echo "  ‚úì Updated actions/cache@v1 to @v4"
                changes_made=true
                changed_files+=("$file")
              fi
              
              # Fix actions/cache@v2 -> actions/cache@v4
              if grep -q "actions/cache@v2" "$file"; then
                sed -i 's|actions/cache@v2|actions/cache@v4|g' "$file"
                echo "  ‚úì Updated actions/cache@v2 to @v4"
                changes_made=true
                changed_files+=("$file")
              fi
              
              # Check for other commonly deprecated actions
              # actions/checkout@v1 or v2 -> actions/checkout@v4
              if grep -q "actions/checkout@v[12]" "$file"; then
                sed -i 's|actions/checkout@v[12]|actions/checkout@v4|g' "$file"
                echo "  ‚úì Updated actions/checkout to @v4"
                changes_made=true
                changed_files+=("$file")
              fi
              
              # actions/setup-node@v1 or v2 -> actions/setup-node@v4
              if grep -q "actions/setup-node@v[12]" "$file"; then
                sed -i 's|actions/setup-node@v[12]|actions/setup-node@v4|g' "$file"
                echo "  ‚úì Updated actions/setup-node to @v4"
                changes_made=true
                changed_files+=("$file")
              fi
              
              # actions/setup-python@v1 or v2 -> actions/setup-python@v5
              if grep -q "actions/setup-python@v[12]" "$file"; then
                sed -i 's|actions/setup-python@v[12]|actions/setup-python@v5|g' "$file"
                echo "  ‚úì Updated actions/setup-python to @v5"
                changes_made=true
                changed_files+=("$file")
              fi
              
              # Remove backup if no changes
              if cmp -s "$file" "${file}.bak"; then
                rm "${file}.bak"
              else
                rm "${file}.bak"
              fi
            fi
          done
          
          echo "changes_made=$changes_made" >> $GITHUB_OUTPUT
          echo "branch_name=$branch_name" >> $GITHUB_OUTPUT
          
          if [ "$changes_made" = true ]; then
            echo "Changes detected. Summary:"
            for file in "${changed_files[@]}"; do
              echo "  - $file"
            done
          else
            echo "No deprecated actions found. All workflows are up to date!"
          fi
      

      - name: Validate YAML syntax
        if: steps.fix-actions.outputs.changes_made == 'true'
        run: |
          echo "=== Validating YAML Syntax ==="
          validation_failed=false
          
          # Find all modified workflow files
          workflow_files=$(find .github/workflows -type f \( -name "*.yml" -o -name "*.yaml" \) ! -name "auto-fix-deprecated-actions.yml")
          
          for file in $workflow_files; do
            echo "Validating: $file"
            
            # Check if file is valid YAML using Python
            if ! python3 -c "import yaml, sys; yaml.safe_load(open('$file'))" 2>/dev/null; then
              echo "  ‚ùå ERROR: Invalid YAML syntax in $file"
              validation_failed=true
            else
              echo "  ‚úÖ Valid YAML syntax"
            fi
          done
          
          if [ "$validation_failed" = true ]; then
            echo ""
            echo "‚ùå Validation failed: One or more workflow files have invalid YAML syntax"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ All workflow files have valid YAML syntax"
      
      - name: Validate workflow structure
        if: steps.fix-actions.outputs.changes_made == 'true'
        run: |
          echo "=== Validating Workflow Structure ==="
          validation_failed=false
          
          workflow_files=$(find .github/workflows -type f \( -name "*.yml" -o -name "*.yaml" \) ! -name "auto-fix-deprecated-actions.yml")
          
          for file in $workflow_files; do
            echo "Validating structure: $file"
            
            # Check for required top-level keys using simple validation
            # Note: YAML parses 'on:' keyword as boolean True key, not string 'on'
            has_trigger=$(python3 -c "import yaml; w=yaml.safe_load(open('$file')); print(True in w or 'on' in w)" 2>/dev/null)
            has_jobs=$(python3 -c "import yaml; w=yaml.safe_load(open('$file')); print('jobs' in w)" 2>/dev/null)
            has_name=$(python3 -c "import yaml; w=yaml.safe_load(open('$file')); print('name' in w)" 2>/dev/null)
            
            if [ "$has_name" != "True" ]; then
              echo "  ‚ö†Ô∏è  WARNING: Missing 'name' field"
            fi
            
            if [ "$has_trigger" != "True" ]; then
              echo "  ‚ùå ERROR: Missing 'on' field (required)"
              validation_failed=true
            fi
            
            if [ "$has_jobs" != "True" ]; then
              echo "  ‚ùå ERROR: Missing 'jobs' field (required)"
              validation_failed=true
            fi
            
            # Check that all 'uses' actions are properly formatted
            while IFS= read -r line; do
              if [[ "$line" =~ uses:[[:space:]]*([^[:space:]]+) ]]; then
                action="${BASH_REMATCH[1]}"
                # Remove quotes if present
                action="${action//\"/}"
                action="${action//\'/}"
                
                # Validate action format (owner/repo@ref or ./path or docker://)
                # Note: ref can include forward slashes for branch names, repos can have dots
                if [[ ! "$action" =~ ^[a-zA-Z0-9._-]+/[a-zA-Z0-9._-]+@[a-zA-Z0-9._/-]+$ ]] && [[ ! "$action" =~ ^\./.*$ ]] && [[ ! "$action" =~ ^docker:// ]]; then
                  echo "  ‚ö†Ô∏è  WARNING: Unusual action format: $action"
                fi
              fi
            done < "$file"
            
            # Print success only if no validation errors for this file
            if [ "$validation_failed" = false ]; then
              echo "  ‚úÖ Workflow structure is valid"
            fi
          done
          
          if [ "$validation_failed" = true ]; then
            echo ""
            echo "‚ùå Validation failed: One or more workflow files have structural issues"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ All workflow files have valid structure"
      
      - name: Verify action versions exist
        if: steps.fix-actions.outputs.changes_made == 'true'
        run: |
          echo "=== Verifying Action Versions ==="
          
          # List of actions we commonly update
          declare -A actions_to_verify=(
            ["actions/cache"]="v4"
            ["actions/checkout"]="v4"
            ["actions/setup-node"]="v4"
            ["actions/setup-python"]="v5"
          )
          
          for action in "${!actions_to_verify[@]}"; do
            version="${actions_to_verify[$action]}"
            echo "Checking if $action@$version exists..."
            
            # Use GitHub API to check if the tag/release exists
            if curl -sSf -o /dev/null "https://github.com/$action/releases/tag/$version" 2>/dev/null || \
               curl -sSf -o /dev/null "https://github.com/$action/tree/$version" 2>/dev/null; then
              echo "  ‚úÖ $action@$version exists"
            else
              echo "  ‚ö†Ô∏è  WARNING: Could not verify $action@$version (network issue or does not exist)"
            fi
          done
          
          echo ""
          echo "‚úÖ Action version verification complete"
      
      - name: Create Pull Request
        if: steps.fix-actions.outputs.changes_made == 'true'
        run: |
          branch_name="${{ steps.fix-actions.outputs.branch_name }}"
          
          # Create new branch
          git checkout -b "$branch_name"
          
          # Stage all changes
          git add .github/workflows/
          
          # Commit changes
          git commit -m "chore: update deprecated actions to latest versions

          Automated update of deprecated GitHub Actions:
          - actions/cache@v1,v2 ‚Üí actions/cache@v4
          - actions/checkout@v1,v2 ‚Üí actions/checkout@v4
          - actions/setup-node@v1,v2 ‚Üí actions/setup-node@v4
          - actions/setup-python@v1,v2 ‚Üí actions/setup-python@v5
          
          This ensures compatibility with the latest GitHub Actions features
          and security updates."
          
          # Push branch
          git push origin "$branch_name"
          
          # Create PR using GitHub CLI (if available) or API
          if command -v gh &> /dev/null; then
            gh pr create \
              --title "chore: update deprecated GitHub Actions to latest versions" \
              --body "## Automated Update of Deprecated Actions

          This PR automatically updates deprecated GitHub Actions to their latest versions.

          ### Changes Made:
          - ‚úÖ \`actions/cache@v1\` and \`v2\` ‚Üí \`actions/cache@v4\`
          - ‚úÖ \`actions/checkout@v1\` and \`v2\` ‚Üí \`actions/checkout@v4\`
          - ‚úÖ \`actions/setup-node@v1\` and \`v2\` ‚Üí \`actions/setup-node@v4\`
          - ‚úÖ \`actions/setup-python@v1\` and \`v2\` ‚Üí \`actions/setup-python@v5\`

          ### Validation Performed:
          - ‚úÖ YAML syntax validation
          - ‚úÖ Workflow structure validation
          - ‚úÖ Action version existence verification

          ### Why These Updates?
          - **Security**: Newer versions include important security patches
          - **Performance**: Latest versions offer improved caching and performance
          - **Compatibility**: Ensures compatibility with current GitHub Actions infrastructure
          - **Deprecation**: Older versions are deprecated and may stop working

          ### Testing
          All modified workflow files have been validated for:
          - Correct YAML syntax
          - Valid workflow structure
          - Existence of target action versions

          Please review the changes and ensure all workflows continue to function correctly.

          ---
          ü§ñ This PR was created automatically by the \`auto-fix-deprecated-actions\` workflow." \
              --base main \
              --head "$branch_name"
          else
            echo "GitHub CLI not available. Please create PR manually from branch: $branch_name"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Summary
        run: |
          if [ "${{ steps.fix-actions.outputs.changes_made }}" = "true" ]; then
            echo "‚úÖ Deprecated actions found and fixed!"
            echo "‚úÖ YAML syntax validation passed"
            echo "‚úÖ Workflow structure validation passed"
            echo "‚úÖ Action version verification completed"
            echo "üìã A pull request has been created with the updates."
          else
            echo "‚úÖ All workflows are using up-to-date actions!"
            echo "üéâ No changes needed."
          fi
